import os
import yaml

# Directory where your projects are located
projects_directory = "/path/to/projects"

# Content to add inside existing blocks
content_to_add = """
include:
  - project: zzz
    file: zzz

variables:
  nexus_iq_scan_path: .
  nexus_scan_stage: release

stages:
  - nexusiq-scan
"""

# Iterate through each project directory
for project_dir in os.listdir(projects_directory):
    project_path = os.path.join(projects_directory, project_dir)
    gitlab_ci_file = os.path.join(project_path, ".gitlab-ci.yml")

    # Check if .gitlab-ci.yml exists in the project directory
    if os.path.isfile(gitlab_ci_file):
        with open(gitlab_ci_file, 'r') as file:
            original_content = file.read()

        # Find the last index of "---" to ensure appending the new content at the end
        last_separator_index = original_content.rfind('---')

        # If there's no "---", we assume it's an empty YAML file
        if last_separator_index == -1:
            updated_content = original_content.strip() + '\n' + content_to_add.strip()
        else:
            # Insert the new content after the last "---"
            updated_content = original_content[:last_separator_index].strip() + '\n' + content_to_add.strip() + '\n' + original_content[last_separator_index:].strip()

        # Write updated content back to the .gitlab-ci.yml file
        with open(gitlab_ci_file, 'w') as file:
            file.write(updated_content)
            print(f"Updated .gitlab-ci.yml in project {project_dir}")
    else:
        print(f".gitlab-ci.yml not found in project {project_dir}")
